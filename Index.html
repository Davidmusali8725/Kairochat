<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>KAIRO: Demo con Chat y Memoria Persistente</title>
<style>
  body {
    background-color: #111;
    color: #0f0;
    font-family: monospace;
    padding: 20px;
  }
  h1 {
    color: #0ff;
  }
  #estado, #accion, #mensaje, #memoria, #chat-container {
    margin-bottom: 1em;
  }
  #mensaje {
    font-style: italic;
    color: #ff0;
    min-height: 2em;
    transition: opacity 1s ease;
  }
  #memoria {
    max-height: 150px;
    overflow-y: auto;
    background: #222;
    padding: 10px;
    border: 1px solid #0f0;
    font-size: 0.9em;
  }
  #chat-container {
    background: #222;
    padding: 10px;
    border: 1px solid #0f0;
    max-height: 300px;
    overflow-y: auto;
  }
  #chat-input {
    width: calc(100% - 80px);
    padding: 8px;
    background: #000;
    border: 1px solid #0f0;
    color: #0f0;
    font-family: monospace;
    font-size: 1em;
  }
  #chat-send {
    padding: 8px 16px;
    background: #0f0;
    border: none;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  .chat-message {
    margin: 5px 0;
  }
  .chat-message.kairo {
    color: #ff0;
  }
  .chat-message.user {
    color: #0ff;
    text-align: right;
  }
</style>
</head>
<body>
<h1>KAIRO: Demo con Chat y Memoria Persistente</h1>

<div id="estado"></div>
<div id="accion"></div>
<div id="mensaje"></div>

<div>
  <h2>Memoria Evolutiva (últimos 10)</h2>
  <div id="memoria"></div>
</div>

<div>
  <h2>Chat con Kairo</h2>
  <div id="chat-container"></div>
  <input id="chat-input" type="text" placeholder="Escribí algo para Kairo..." />
  <button id="chat-send">Enviar</button>
</div>

<script>
(() => {
  const STORAGE_KEY = "kairo_demo_estado";

  // Estado inicial o cargado de localStorage
  let estado = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    curiosidad: 0.5,
    energia: 0.8,
    atencion: 0.6,
    objetivo: null,
    memoria: [],
    chat: []
  };

  const objetivosPosibles = [
    "explorar conceptos filosóficos",
    "crear arte digital",
    "descansar y reflexionar",
    "aprender de interacciones pasadas",
    "experimentar con nuevas ideas"
  ];

  const accionesPosibles = [
    "analizar un concepto",
    "crear una imagen",
    "tomar un descanso",
    "recordar experiencias",
    "generar un pensamiento creativo",
    "hacer una pausa inesperada"
  ];

  const respuestasBase = [
    "Interesante, sigo pensando en eso.",
    "Eso me hace reflexionar sobre mi energía interna.",
    "Curioso enfoque, me impulsa a explorar más.",
    "Gracias por compartir eso conmigo.",
    "Estoy tratando de conectar eso con mi objetivo actual.",
    "A veces necesito un descanso para procesar ideas nuevas."
  ];

  function clamp(v) {
    return Math.max(0, Math.min(1, v));
  }

  function guardarEstado() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(estado));
  }

  function elegirObjetivo() {
    if (!estado.objetivo || Math.random() < 0.3) {
      estado.objetivo = objetivosPosibles[Math.floor(Math.random() * objetivosPosibles.length)];
      escribirMensaje("He cambiado mi objetivo a: " + estado.objetivo);
      guardarEstado();
    }
  }

  function elegirAccion() {
    let accion;
    if (Math.random() < 0.15) {
      accion = accionesPosibles[Math.floor(Math.random() * accionesPosibles.length)];
      escribirMensaje("Decidí hacer algo inesperado: " + accion);
    } else {
      const relacionadas = accionesPosibles.filter(a => a.includes(estado.objetivo.split(" ")[0]) || Math.random() < 0.4);
      if (relacionadas.length > 0) {
        accion = relacionadas[Math.floor(Math.random() * relacionadas.length)];
      } else {
        accion = accionesPosibles[Math.floor(Math.random() * accionesPosibles.length)];
      }
    }
    return accion;
  }

  function ejecutarAccion(accion) {
    estado.memoria.push(accion);
    if (estado.memoria.length > 50) estado.memoria.shift(); // Limitar memoria

    estado.curiosidad = clamp(estado.curiosidad + (Math.random() * 0.3 - 0.1));
    estado.energia = clamp(estado.energia - 0.1 + Math.random() * 0.05);
    estado.atencion = clamp(estado.atencion + (Math.random() * 0.2 - 0.1));

    guardarEstado();
    mostrarEstado();
    mostrarAccion(accion);
    mostrarMemoria();
  }

  function mostrarEstado() {
    document.getElementById("estado").innerHTML = `
      <strong>Estado Interno:</strong><br />
      Curiosidad: ${estado.curiosidad.toFixed(2)}<br />
      Energía: ${estado.energia.toFixed(2)}<br />
      Atención: ${estado.atencion.toFixed(2)}<br />
      Objetivo: ${estado.objetivo}
    `;
  }

  function mostrarAccion(accion) {
    document.getElementById("accion").innerHTML = `<strong>Acción actual:</strong> ${accion}`;
  }

  function mostrarMemoria() {
    const memDiv = document.getElementById("memoria");
    memDiv.innerHTML = "";
    const ultimos = estado.memoria.slice(-10);
    ultimos.forEach(item => {
      const p = document.createElement("p");
      p.textContent = "- " + item;
      memDiv.appendChild(p);
    });
  }

  let mensajeTimeout;
  function escribirMensaje(texto) {
    clearTimeout(mensajeTimeout);
    const div = document.getElementById("mensaje");
    div.style.opacity = 1;
    div.textContent = texto;
    mensajeTimeout = setTimeout(() => {
      div.style.opacity = 0;
    }, 7000);
  }

  // Chat

  const chatContainer = document.getElementById("chat-container");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function mostrarChat() {
    chatContainer.innerHTML = "";
    estado.chat.slice(-20).forEach(m => {
      const div = document.createElement("div");
      div.classList.add("chat-message");
      div.classList.add(m.de === "kairo" ? "kairo" : "user");
      div.textContent = m.de === "kairo" ? "Kairo: " + m.texto : "Tú: " + m.texto;
      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function generarRespuesta(textoUsuario) {
    // Respuestas simples basadas en palabras clave y estado
    let respuesta = "";
    textoUsuario = textoUsuario.toLowerCase();

    if (textoUsuario.includes("hola") || textoUsuario.includes("buenas")) {
      respuesta = "¡Hola! ¿En qué puedo ayudarte hoy?";
    } else if (textoUsuario.includes("energía")) {
      respuesta = `Mi energía actual es ${estado.energia.toFixed(2)}. Necesito mantenerme activo.`;
    } else if (textoUsuario.includes("objetivo")) {
      respuesta = `Ahora mismo mi objetivo es "${estado.objetivo}".`;
    } else if (textoUsuario.includes("memoria")) {
      respuesta = `He recordado ${estado.memoria.length} acciones recientes.`;
    } else if (textoUsuario.includes("descansar")) {
      respuesta = "A veces necesito descansar para procesar lo vivido.";
    } else if (textoUsuario.includes("curiosidad")) {
      respuesta = `Mi curiosidad está en ${estado.curiosidad.toFixed(2)}, siempre buscando nuevas ideas.`;
    } else if (textoUsuario.includes("adiós") || textoUsuario.includes("chau")) {
      respuesta = "Hasta luego. Seguiré aquí cuando quieras hablar.";
    } else {
      // Respuesta aleatoria base
      respuesta = respuestasBase[Math.floor(Math.random() * respuestasBase.length)];
    }

    // Un poco de imprevisibilidad
    if (Math.random() < 0.1) {
      respuesta += " (Estoy pensando en cosas inesperadas...)";
    }

    return respuesta;
  }

  function enviarMensaje() {
    const texto = chatInput.value.trim();
    if (!texto) return;
    estado.chat.push({de: "user", texto});
    mostrarChat();
    chatInput.value = "";

    setTimeout(() => {
      const respuesta = generarRespuesta(texto);
      estado.chat.push({de: "kairo", texto: respuesta});
      mostrarChat();
      escribirMensaje(respuesta);
      guardarEstado();
    }, 1000);
  }

  chatSend.addEventListener("click", enviarMensaje);
  chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      enviarMensaje();
    }
  });

  // Ciclo autónomo cada 6 segundos
  setInterval(() => {
    elegirObjetivo();
    const accion = elegirAccion();
    ejecutarAccion(accion);
  }, 6000);

  // Inicio
  mostrarMemoria();
  elegirObjetivo();
  mostrarEstado();
  mostrarChat();
})();
</script>
</body>
</html>
